
{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex align-items-center">
            {% if server_stats.icon %}
            <img src="{{ server_stats.icon }}" class="rounded me-3" style="width: 64px; height: 64px;" alt="Server Icon">
            {% endif %}
            <div>
                <h1 class="display-5 mb-0">{{ server_stats.name }}</h1>
                <p class="text-muted mb-0">Owner: {{ server_stats.owner }} ‚Ä¢ Created: {{ server_stats.created_at }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Server Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <div class="coconut-emoji">üë•</div>
                <div class="metric-value">{{ "{:,}".format(server_stats.member_count) }}</div>
                <small class="text-muted">Members</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <div class="coconut-emoji">üìÅ</div>
                <div class="metric-value">{{ server_stats.channel_count }}</div>
                <small class="text-muted">Channels</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <div class="coconut-emoji">üé≠</div>
                <div class="metric-value">{{ server_stats.role_count }}</div>
                <small class="text-muted">Roles</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <div class="coconut-emoji">‚öôÔ∏è</div>
                <div class="metric-value">Active</div>
                <small class="text-muted">Bot Status</small>
            </div>
        </div>
    </div>
</div>

<!-- Navigation Tabs -->
<div class="dashboard-section" id="overview-section">
    <div class="row">
        <!-- Economy Overview -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ü™ô Economy Overview</h5>
                </div>
                <div class="card-body">
                    <div id="economy-stats">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading economy data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Karma Overview -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">‚ú® Karma Overview</h5>
                </div>
                <div class="card-body">
                    <div id="karma-stats">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading karma data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Economy Section -->
<div class="dashboard-section" id="economy-section" style="display: none;">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ü™ô Vaazha Coins Economy System</h5>
                </div>
                <div class="card-body">
                    <div id="detailed-economy-stats">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading detailed economy data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Karma Section -->
<div class="dashboard-section" id="karma-section" style="display: none;">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">‚ú® Karma System Analytics</h5>
                </div>
                <div class="card-body">
                    <div id="detailed-karma-stats">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading detailed karma data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Section -->
<div class="dashboard-section" id="config-section" style="display: none;">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">‚öôÔ∏è Server Configuration</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>üõ°Ô∏è Moderator Roles</h6>
                            <p><strong>Main Moderator:</strong> {{ server_data.main_moderator_role or 'Not set' }}</p>
                            <p><strong>Junior Moderator:</strong> {{ server_data.junior_moderator_role or 'Not set' }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>üìã Logging</h6>
                            <p><strong>Log Channels:</strong> {{ server_data.log_channels|length if server_data.log_channels else 0 }} configured</p>
                            <p><strong>Organized Logs:</strong> {{ 'Yes' if server_data.organized_log_channels else 'No' }}</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6>üëã Welcome System</h6>
                            <p><strong>Welcome Channel:</strong> {{ server_data.welcome_channel or 'Not set' }}</p>
                            <p><strong>Auto Role:</strong> {{ server_data.auto_role or 'Not set' }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>üé´ Tickets</h6>
                            <p><strong>Support Role:</strong> {{ server_data.ticket_support_role or 'Not set' }}</p>
                            <p><strong>Ticket Categories:</strong> {{ server_data.ticket_categories|length if server_data.ticket_categories else 0 }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const serverId = {{ selected_server }};

function loadEconomyStats() {
    fetch(`/api/economy/${serverId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('economy-stats').innerHTML = `<p class="text-danger">Error: ${data.error}</p>`;
                return;
            }
            
            const html = `
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-warning">${data.total_users.toLocaleString()}</h4>
                        <small>Active Users</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-warning">${(data.circulation.total_coins + data.circulation.total_bank).toLocaleString()}</h4>
                        <small>Total Coins</small>
                    </div>
                </div>
                <hr>
                <h6>üèÜ Richest Members</h6>
                <div class="list-group list-group-flush">
                    ${data.richest.slice(0, 5).map((user, index) => `
                        <div class="list-group-item bg-transparent border-0 d-flex align-items-center">
                            <img src="${user.avatar}" class="user-avatar me-2" alt="Avatar">
                            <span class="me-auto">${user.name}</span>
                            <span class="badge bg-warning">${user.total_wealth.toLocaleString()} ü™ô</span>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('economy-stats').innerHTML = html;
        })
        .catch(error => {
            document.getElementById('economy-stats').innerHTML = `<p class="text-danger">Failed to load economy data</p>`;
        });
}

function loadKarmaStats() {
    fetch(`/api/karma/${serverId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('karma-stats').innerHTML = `<p class="text-danger">Error: ${data.error}</p>`;
                return;
            }
            
            const html = `
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-warning">${data.total_users.toLocaleString()}</h4>
                        <small>Karma Users</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-warning">${data.stats.total_karma.toLocaleString()}</h4>
                        <small>Total Karma</small>
                    </div>
                </div>
                <hr>
                <h6>‚≠ê Top Karma Holders</h6>
                <div class="list-group list-group-flush">
                    ${data.top_karma.slice(0, 5).map((user, index) => `
                        <div class="list-group-item bg-transparent border-0 d-flex align-items-center">
                            <img src="${user.avatar}" class="user-avatar me-2" alt="Avatar">
                            <span class="me-auto">${user.name}</span>
                            <span class="badge bg-warning">${user.karma} ‚ú®</span>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('karma-stats').innerHTML = html;
        })
        .catch(error => {
            document.getElementById('karma-stats').innerHTML = `<p class="text-danger">Failed to load karma data</p>`;
        });
}

function refreshStats() {
    loadEconomyStats();
    loadKarmaStats();
}

// Load initial data
loadEconomyStats();
loadKarmaStats();

// Show overview section by default
document.getElementById('overview-section').style.display = 'block';
</script>
{% endblock %}
